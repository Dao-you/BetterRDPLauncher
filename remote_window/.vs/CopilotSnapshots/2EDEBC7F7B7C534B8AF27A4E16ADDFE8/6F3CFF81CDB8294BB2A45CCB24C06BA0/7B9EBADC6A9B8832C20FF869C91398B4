using System;
using System.Collections.Generic;
using System.ComponentModel;
using System.Data;
using System.Drawing;
using System.Linq;
using System.Text;
using System.Threading.Tasks;
using System.Windows.Forms;

namespace remote_window
{
    public partial class Form1 : Form
    {
        public Form1()
        {
            InitializeComponent();
        }

        private void chkToggleVisibleRemoteAddress_CheckedChanged(object sender, EventArgs e)
        {
            // Toggle masking for the remote address textbox (show/hide text like password)
            try
            {
                var chk = sender as CheckBox;
                if (chk != null && this.textRemoteAddress != null)
                {
                    // when checked -> show the address (no mask)
                    // when unchecked -> mask the address
                    this.textRemoteAddress.UseSystemPasswordChar = !chk.Checked;
                }
            }
            catch
            {
                // safe fail
            }
        }

        private void chkVisibleTogglePassword_CheckedChanged(object sender, EventArgs e)
        {
            // Toggle password masking for the password textbox
            try
            {
                var chk = sender as CheckBox;
                if (chk != null && this.textPassword != null)
                {
                    this.textPassword.UseSystemPasswordChar = !chk.Checked;
                }
            }
            catch
            {
                // ignore
            }

        }

        private void chkFullscreen_CheckedChanged(object sender, EventArgs e)
        {
            // When fullscreen enabled: allow multi-screen, disable resolution trackbar
            // and dim the resolution labels. Reverse when disabled.
            try
            {
                var chk = sender as CheckBox;
                if (chk == null) return;

                if (this.chkMultiScreen != null)
                    this.chkMultiScreen.Enabled = chk.Checked;

                if (this.trackRes != null)
                    this.trackRes.Enabled = !chk.Checked;

                var gray = SystemColors.GrayText;
                var normal = SystemColors.ControlText;
                if (this.lblNowRes != null)
                    this.lblNowRes.ForeColor = chk.Checked ? gray : normal;
                if (this.lblHintChoosingRes != null)
                    this.lblHintChoosingRes.ForeColor = chk.Checked ? gray : normal;
            }
            catch
            {
                // ignore
            }
        }

        private void trackRes_Scroll(object sender, EventArgs e)
        {
            // update the resolution label "lblNowRes" when the trackbar is scrolled
            string[] resolutions = new string[]
            {
                "640x480",
                "800x600",
                "1024x768",
                "1280x720",
                "1280x768",
                "1280x800",
                "1280x1024",
                "1366x768",
                "1440x900",
                "1400x1050",
                "1680x1050",
                "1920x1080"
            };

            if (this.trackRes != null && this.lblNowRes != null)
            {
                int idx = this.trackRes.Value;
                if (idx >= 0 && idx < resolutions.Length)
                {
                    this.lblNowRes.Text = resolutions[idx];
                }
            }
        }

        private void btnSaveNew_Click(object sender, EventArgs e)
        {
            try
            {
                // 1. 讓使用者輸入自訂名稱
                string inputName = ShowInputDialog("請輸入檔案名稱（不需副檔名）", "另存為 RDP 設定");
                if (string.IsNullOrWhiteSpace(inputName))
                    return;
                // 移除不合法字元
                foreach (char c in System.IO.Path.GetInvalidFileNameChars())
                    inputName = inputName.Replace(c.ToString(), "_");
                string fileName = inputName + ".rdp";

                // Prepare RDP settings
                string remoteAddress = this.textRemoteAddress?.Text ?? "";
                string port = this.numRemotePort?.Value.ToString() ?? "3389";
                string username = this.comboUserAccount?.Text ?? "";
                string resolution = this.lblNowRes?.Text ?? "1920x1080";
                bool fullscreen = this.chkFullscreen?.Checked ?? true;
                bool multiScreen = this.chkMultiScreen?.Checked ?? false;
                string colorDepth = (this.radColordepth32 != null && this.radColordepth32.Checked) ? "32" : "16";

                // 音效設定
                int audiomode = 0; // 0: 本機, 1: 遠端, 2: 不播放
                if (this.radAudio_remote != null && this.radAudio_remote.Checked)
                    audiomode = 1;
                else if (this.radAudio_noplay != null && this.radAudio_noplay.Checked)
                    audiomode = 2;

                int audiocapturemode = 0; // 1: 啟用錄音, 0: 不錄音
                if (this.radRecord_local != null && this.radRecord_local.Checked)
                    audiocapturemode = 1;

                // 資源設定
                int redirectclipboard = 0, redirectprinters = 0, redirectsmartcards = 0, redirectcomports = 0, redirectdrives = 0;
                if (this.treeDeviceList != null)
                {
                    foreach (TreeNode node in this.treeDeviceList.Nodes)
                    {
                        if (node.Name == "Clipboard") redirectclipboard = node.Checked ? 1 : 0;
                        if (node.Name == "Printer") redirectprinters = node.Checked ? 1 : 0;
                        if (node.Name == "SmartCard") redirectsmartcards = node.Checked ? 1 : 0;
                        if (node.Name == "Ports") redirectcomports = node.Checked ? 1 : 0;
                        if (node.Name == "Drive") redirectdrives = node.Checked ? 1 : 0;
                    }
                }

                // Parse resolution
                string[] resParts = resolution.Split('x');
                string width = resParts.Length > 0 ? resParts[0] : "1920";
                string height = resParts.Length > 1 ? resParts[1] : "1080";

                // Build RDP file content
                var sb = new System.Text.StringBuilder();
                sb.AppendLine($"full address:s:{remoteAddress}:{port}");
                sb.AppendLine($"username:s:{username}");
                sb.AppendLine($"screen mode id:i:{(fullscreen ? 2 : 1)}");
                sb.AppendLine($"use multimon:i:{(multiScreen ? 1 : 0)}");
                sb.AppendLine($"desktopwidth:i:{width}");
                sb.AppendLine($"desktopheight:i:{height}");
                sb.AppendLine($"session bpp:i:{colorDepth}");
                // 音效
                sb.AppendLine($"audiomode:i:{audiomode}");
                sb.AppendLine($"audiocapturemode:i:{audiocapturemode}");
                // 資源
                sb.AppendLine($"redirectclipboard:i:{redirectclipboard}");
                sb.AppendLine($"redirectprinters:i:{redirectprinters}");
                sb.AppendLine($"redirectcomports:i:{redirectcomports}");
                sb.AppendLine($"redirectsmartcards:i:{redirectsmartcards}");
                sb.AppendLine($"redirectdrives:i:{redirectdrives}");
                // Password is not saved in plaintext for RDP files

                // Ensure directory exists
                string rdpDir = System.IO.Path.Combine(
                    Environment.GetFolderPath(Environment.SpecialFolder.UserProfile),
                    "RDP");
                if (!System.IO.Directory.Exists(rdpDir))
                    System.IO.Directory.CreateDirectory(rdpDir);

                // 直接用自訂名稱存檔
                string filePath = System.IO.Path.Combine(rdpDir, fileName);

                // Write file
                System.IO.File.WriteAllText(filePath, sb.ToString(), System.Text.Encoding.Unicode);

                MessageBox.Show($"RDP 設定已儲存至: {filePath}", "儲存成功", MessageBoxButtons.OK, MessageBoxIcon.Information);
            }
            catch (Exception ex)
            {
                MessageBox.Show($"儲存 RDP 設定時發生錯誤: {ex.Message}", "錯誤", MessageBoxButtons.OK, MessageBoxIcon.Error);
            }

        }

        // 顯示簡單的 InputBox 讓使用者輸入檔名
        public static string ShowInputDialog(string text, string caption)
        {
            Form prompt = new Form()
            {
                Width = 360,
                Height = 150,
                FormBorderStyle = FormBorderStyle.FixedDialog,
                Text = caption,
                StartPosition = FormStartPosition.CenterScreen
            };
            Label textLabel = new Label() { Left = 20, Top = 20, Text = text, Width = 300 };
            TextBox inputBox = new TextBox() { Left = 20, Top = 50, Width = 300 };
            Button confirmation = new Button() { Text = "確定", Left = 170, Width = 70, Top = 80, DialogResult = DialogResult.OK };
            Button cancel = new Button() { Text = "取消", Left = 250, Width = 70, Top = 80, DialogResult = DialogResult.Cancel };
            prompt.Controls.Add(textLabel);
            prompt.Controls.Add(inputBox);
            prompt.Controls.Add(confirmation);
            prompt.Controls.Add(cancel);
            prompt.AcceptButton = confirmation;
            prompt.CancelButton = cancel;

            return prompt.ShowDialog() == DialogResult.OK ? inputBox.Text : string.Empty;
        }
    }
}
